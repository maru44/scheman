package notion

import (
	"context"
	"strings"

	gn "github.com/dstotijn/go-notion"
	"github.com/maru44/scheman/definition"
)

type (
	columnProps struct {
		// title
		ColumnName gn.DatabasePageProperty `json:"Column Name"`
		// select
		DataType gn.DatabasePageProperty `json:"Data Type"`
		// rich_text
		Default gn.DatabasePageProperty `json:"Default,omitempty"`
		// checkbox
		PK gn.DatabasePageProperty `json:"PK"`
		// checkbox
		AutoGen gn.DatabasePageProperty `json:"Auto Generate"`
		// checkbox
		Unique gn.DatabasePageProperty `json:"Unique"`
		// checkbox
		Nullable gn.DatabasePageProperty `json:"Null"`
		// rich_text
		Comment gn.DatabasePageProperty `json:"Comment,omitempty"`
		// rich_text
		Enum gn.DatabasePageProperty `json:"Enum,omitempty"`
		// rich_text
		FreeText gn.DatabasePageProperty `json:"Free Entry,omitempty"`
	}
)

func (n *Notion) createDefRow(ctx context.Context, tableID string, column definition.Column) error {
	if _, err := n.cli.CreatePage(ctx, gn.CreatePageParams{
		ParentType:             gn.ParentTypeDatabase,
		ParentID:               tableID,
		DatabasePageProperties: n.notionDBPropsFromDriversTable(column),
	}); err != nil {
		return err
	}
	return nil
}

func (n *Notion) updateDefRow(ctx context.Context, column definition.Column) error {
	if _, err := n.cli.UpdatePage(ctx, column.RowID, gn.UpdatePageParams{
		DatabasePageProperties: n.notionDBPropsFromDriversTable(column),
	}); err != nil {
		return err
	}
	return nil
}

func (n *Notion) notionDBPropsFromDriversTable(col definition.Column) *gn.DatabasePageProperties {
	dbProps := &gn.DatabasePageProperties{
		"Column Name": gn.DatabasePageProperty{
			Title: []gn.RichText{
				{
					Text: &gn.Text{
						Content: col.Name,
					},
				},
			},
		},
	}

	if _, ok := n.IgnoreAttributes["Data Type"]; !ok {
		(*dbProps)["Data Type"] = gn.DatabasePageProperty{
			Select: &gn.SelectOptions{
				Name: col.DBType,
			},
		}
	}
	if _, ok := n.IgnoreAttributes["PK"]; !ok {
		(*dbProps)["PK"] = gn.DatabasePageProperty{
			Checkbox: gn.BoolPtr(col.PK),
		}
	}
	if _, ok := n.IgnoreAttributes["Auto Generate"]; !ok {
		(*dbProps)["Auto Generate"] = gn.DatabasePageProperty{
			Checkbox: gn.BoolPtr(col.AutoGenerated),
		}
	}
	if _, ok := n.IgnoreAttributes["Unique"]; !ok {
		(*dbProps)["Unique"] = gn.DatabasePageProperty{
			Checkbox: gn.BoolPtr(col.Unique),
		}
	}
	if _, ok := n.IgnoreAttributes["Null"]; !ok {
		(*dbProps)["Null"] = gn.DatabasePageProperty{
			Checkbox: gn.BoolPtr(col.Nullable),
		}
	}

	if _, ok := n.IgnoreAttributes["Default"]; !ok && col.Default != "" {
		(*dbProps)["Default"] = gn.DatabasePageProperty{
			RichText: []gn.RichText{
				{
					Text: &gn.Text{
						Content: col.Default,
					},
				},
			},
		}
	}
	if _, ok := n.IgnoreAttributes["Comment"]; !ok && col.Comment != "" {
		(*dbProps)["Comment"] = gn.DatabasePageProperty{
			RichText: []gn.RichText{
				{
					Text: &gn.Text{
						Content: col.Comment,
					},
				},
			},
		}
	}
	if _, ok := n.IgnoreAttributes["Free Entry"]; !ok && col.FreeText != "" {
		(*dbProps)["Free Entry"] = gn.DatabasePageProperty{
			RichText: []gn.RichText{
				{
					Text: &gn.Text{
						Content: col.FreeText,
					},
				},
			},
		}
	}
	if _, ok := n.IgnoreAttributes["Enum"]; !ok && len(col.Enum) != 0 {
		opts := make([]gn.SelectOptions, len(col.Enum))
		for i, e := range col.Enum {
			opts[i] = gn.SelectOptions{
				Name: strings.Trim(e, "'"),
			}
		}
		(*dbProps)["Enum"] = gn.DatabasePageProperty{
			MultiSelect: opts,
		}
	}

	return dbProps
}

func (n *Notion) updateAttrProps(ctx context.Context, tableID string) (map[string]*gn.DatabaseProperty, error) {
	db, err := n.cli.FindDatabaseByID(ctx, tableID)
	if err != nil {
		return nil, err
	}
	notionAttrs := map[string]int{}
	for _, a := range allAttrs {
		if _, ok := db.Properties[a]; ok {
			notionAttrs[a]++
		}
	}

	props := map[string]*gn.DatabaseProperty{}
	for _, a := range allAttrs {
		if _, ok := n.IgnoreAttributes[a]; ok {
			if _, ok := notionAttrs[a]; ok {
				props[a] = nil
				continue
			}
			continue
		}

		if _, ok := notionAttrs[a]; !ok {
			switch a {
			case "Data Type":
				props[a] = &initialDataTypeProperty
			case "Default", "Comment", "Free Entry":
				props[a] = &initialRichText
			case "Enum":
				props[a] = &gn.DatabaseProperty{
					Type: gn.DBPropTypeMultiSelect,
					MultiSelect: &gn.SelectMetadata{
						Options: []gn.SelectOptions{},
					},
				}
			case "PK", "Auto Generate", "Unique", "Null":
				props[a] = &initialCheckbox
			}
		}
	}
	return props, nil
}
